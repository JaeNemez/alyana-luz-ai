/* Alyana Luz - frontend/app.js */

const $ = (id) => document.getElementById(id);

function setPill(el, text, kind) {
  if (!el) return;
  el.textContent = text;
  el.classList.remove("ok", "warn", "bad");
  if (kind) el.classList.add(kind);
}

function nowTime() {
  try {
    return new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  } catch {
    return "";
  }
}

function addBubble(kind, text, meta = {}) {
  const chat = $("chat");
  if (!chat) return;

  const row = document.createElement("div");
  row.className = `bubble-row ${kind}`;

  const wrap = document.createElement("div");
  wrap.style.display = "flex";
  wrap.style.flexDirection = "column";
  wrap.style.maxWidth = "100%";

  const bubble = document.createElement("div");
  bubble.className = `bubble ${kind}`;
  bubble.textContent = text;

  const metaEl = document.createElement("div");
  metaEl.className = "msg-meta";
  metaEl.textContent = meta.time || nowTime();

  wrap.appendChild(bubble);
  if (kind !== "system") wrap.appendChild(metaEl);

  row.appendChild(wrap);
  chat.appendChild(row);

  // scroll to bottom
  chat.scrollTop = chat.scrollHeight;
}

async function api(path, options = {}) {
  const resp = await fetch(path, {
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    ...options,
  });

  const text = await resp.text();
  let data = null;
  try {
    data = text ? JSON.parse(text) : null;
  } catch {
    data = { raw: text };
  }

  if (!resp.ok) {
    const msg =
      (data && (data.detail || data.error))
        ? (data.detail || data.error)
        : `Request failed (${resp.status})`;
    throw new Error(msg);
  }
  return data;
}

/* =======================
   Chat Memory (device)
======================= */

const CHAT_STATE_KEY = "alyana_chat_state_v1";

function defaultChatState() {
  return {
    messages: [], // { role: "user"|"assistant"|"system", content: string, ts: number }
    memoryMode: "on", // "on"|"off"
    memoryDepth: 10,
    lang: "auto",
  };
}

function loadChatState() {
  try {
    const raw = localStorage.getItem(CHAT_STATE_KEY);
    if (!raw) return defaultChatState();
    const parsed = JSON.parse(raw);
    return {
      ...defaultChatState(),
      ...parsed,
      messages: Array.isArray(parsed.messages) ? parsed.messages : [],
    };
  } catch {
    return defaultChatState();
  }
}

function saveChatState(state) {
  try {
    localStorage.setItem(CHAT_STATE_KEY, JSON.stringify(state));
  } catch {}
}

function clearChatMemory() {
  const state = loadChatState();
  state.messages = [];
  saveChatState(state);

  const chat = $("chat");
  if (chat) chat.innerHTML = "";
  addBubble("system", "Memory cleared for this device.");
}

function appendToMemory(role, content) {
  const state = loadChatState();
  state.messages.push({ role, content, ts: Date.now() });

  // Prevent runaway storage (keep last 200)
  if (state.messages.length > 200) state.messages = state.messages.slice(-200);

  saveChatState(state);
}

function getHistoryForBackend() {
  const state = loadChatState();
  if (state.memoryMode !== "on") return [];

  // We send last N messages excluding "system"
  const depth = Number(state.memoryDepth || 10);
  const msgs = state.messages
    .filter((m) => m && (m.role === "user" || m.role === "assistant"))
    .slice(-depth);

  // Backend expects {role, content}
  return msgs.map((m) => ({ role: m.role, content: m.content }));
}

/* -----------------------
   Navigation
------------------------ */
function setupNav() {
  const buttons = document.querySelectorAll(".menu-btn");
  const sections = document.querySelectorAll(".app-section");

  function activate(targetId) {
    sections.forEach((s) => s.classList.remove("active"));
    const t = document.getElementById(targetId);
    if (t) t.classList.add("active");

    buttons.forEach((b) => b.classList.remove("active"));
    buttons.forEach((b) => {
      if (b.dataset.target === targetId) b.classList.add("active");
    });
  }

  buttons.forEach((b) => {
    b.addEventListener("click", () => activate(b.dataset.target));
  });

  activate("chatSection");
}

/* -----------------------
   Billing + Auth UI
------------------------ */
function showAuthHint(text) {
  const el = $("authHint");
  if (!el) return;
  if (!text) {
    el.style.display = "none";
    el.textContent = "";
    return;
  }
  el.style.display = "block";
  el.textContent = text;
}

function getRestoreEmail() {
  const input = $("loginEmail");
  return (input?.value || "").trim();
}

async function refreshMe() {
  const authPill = $("authPill");
  const manageBillingBtn = $("manageBillingBtn");
  const logoutBtn = $("logoutBtn");

  setPill(authPill, "Account: checking…", "warn");
  showAuthHint("");

  try {
    const me = await api("/me", { method: "GET" });

    if (!me.logged_in) {
      setPill(authPill, "Account: not logged in", "warn");
      if (manageBillingBtn) manageBillingBtn.disabled = true;
      if (logoutBtn) logoutBtn.style.display = "none";
      showAuthHint(
        "To access premium features, subscribe with Support, or restore access using the email you used on Stripe."
      );
      return;
    }

    if (me.active) {
      setPill(authPill, `Account: ${me.email} (active)`, "ok");
      if (manageBillingBtn) manageBillingBtn.disabled = false;
      if (logoutBtn) logoutBtn.style.display = "";
      showAuthHint("");
    } else {
      setPill(authPill, `Account: ${me.email} (inactive)`, "bad");
      if (manageBillingBtn) manageBillingBtn.disabled = false;
      if (logoutBtn) logoutBtn.style.display = "";
      showAuthHint(
        "Your subscription is inactive. Click Support to subscribe, or Manage billing to fix payment/cancel/renew."
      );
    }
  } catch (e) {
    setPill(authPill, "Account: error", "bad");
    if (manageBillingBtn) manageBillingBtn.disabled = true;
    if (logoutBtn) logoutBtn.style.display = "none";
    showAuthHint(e.message);
  }
}

function setupBillingButtons() {
  const supportBtn = $("supportBtn");
  const manageBillingBtn = $("manageBillingBtn");
  const logoutBtn = $("logoutBtn");
  const loginBtn = $("loginBtn");

  if (supportBtn) {
    supportBtn.addEventListener("click", async () => {
      try {
        const email = getRestoreEmail();
        const data = await api("/stripe/create-checkout-session", {
          method: "POST",
          body: JSON.stringify({ email: email || null }),
        });
        if (data && data.url) window.location.href = data.url;
      } catch (e) {
        showAuthHint(`Subscribe error: ${e.message}`);
      }
    });
  }

  if (manageBillingBtn) {
    manageBillingBtn.addEventListener("click", async () => {
      try {
        const email = getRestoreEmail();
        const data = await api("/stripe/create-portal-session", {
          method: "POST",
          body: JSON.stringify({ email: email || null }),
        });
        if (data && data.url) window.location.href = data.url;
      } catch (e) {
        showAuthHint(`Manage billing error: ${e.message}`);
      }
    });
  }

  if (logoutBtn) {
    logoutBtn.addEventListener("click", async () => {
      try {
        await api("/logout", { method: "POST", body: JSON.stringify({}) });
        await refreshMe();
      } catch (e) {
        showAuthHint(`Logout error: ${e.message}`);
      }
    });
  }

  if (loginBtn) {
    loginBtn.addEventListener("click", async () => {
      try {
        const email = getRestoreEmail();
        if (!email) {
          showAuthHint("Type the email you used on Stripe, then click Restore access.");
          return;
        }
        showAuthHint("Checking subscription…");
        await api("/login", { method: "POST", body: JSON.stringify({ email }) });
        showAuthHint("");
        await refreshMe();
      } catch (e) {
        showAuthHint(`Restore failed: ${e.message}`);
      }
    });
  }
}

/* -----------------------
   Chat Saved Chats (manual snapshots)
------------------------ */
function loadSavedChats() {
  const list = $("chatSavedList");
  if (!list) return;

  const saved = JSON.parse(localStorage.getItem("alyana_saved_chats") || "[]");
  list.innerHTML = "";
  if (!saved.length) {
    list.innerHTML = `<small style="opacity:0.75;">No saved chats yet.</small>`;
    return;
  }

  saved.forEach((item, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "block";

    const btn = document.createElement("button");
    btn.className = "btn btn-ghost";
    btn.textContent = item.title;
    btn.addEventListener("click", () => {
      const chat = $("chat");
      chat.innerHTML = "";
      // restore bubbles
      item.messages.forEach((m) => addBubble(m.kind, m.text, { time: m.time || "" }));
    });

    const del = document.createElement("button");
    del.className = "btn btn-danger";
    del.textContent = "Delete";
    del.style.marginTop = "8px";
    del.addEventListener("click", () => {
      saved.splice(idx, 1);
      localStorage.setItem("alyana_saved_chats", JSON.stringify(saved));
      loadSavedChats();
    });

    wrap.appendChild(btn);
    wrap.appendChild(del);
    list.appendChild(wrap);
  });
}

/* -----------------------
   Chat
------------------------ */
function setupChatControlsFromState() {
  const state = loadChatState();
  const langSel = $("chatLangSelect");
  const memMode = $("chatMemoryMode");
  const memDepth = $("chatMemoryDepth");

  if (langSel) langSel.value = state.lang || "auto";
  if (memMode) memMode.value = state.memoryMode || "on";
  if (memDepth) memDepth.value = String(state.memoryDepth || 10);

  if (langSel) {
    langSel.addEventListener("change", () => {
      const s = loadChatState();
      s.lang = langSel.value || "auto";
      saveChatState(s);
    });
  }
  if (memMode) {
    memMode.addEventListener("change", () => {
      const s = loadChatState();
      s.memoryMode = memMode.value || "on";
      saveChatState(s);
      addBubble("system", `Memory is now ${s.memoryMode === "on" ? "ON" : "OFF"}.`);
    });
  }
  if (memDepth) {
    memDepth.addEventListener("change", () => {
      const s = loadChatState();
      s.memoryDepth = Number(memDepth.value || "10");
      saveChatState(s);
      addBubble("system", `Memory depth set to last ${s.memoryDepth} messages.`);
    });
  }

  const clearBtn = $("chatClearMemoryBtn");
  if (clearBtn) clearBtn.addEventListener("click", clearChatMemory);
}

function replayMemoryToScreen() {
  const chat = $("chat");
  if (!chat) return;

  const state = loadChatState();
  chat.innerHTML = "";

  if (!state.messages.length) {
    addBubble("system", "Hi! Try “Read John 1:1”, “Verses about peace”, or “Pray for my family”.");
    return;
  }

  // Render from saved messages
  for (const m of state.messages) {
    const kind = m.role === "assistant" ? "bot" : m.role === "user" ? "user" : "system";
    addBubble(kind, m.content, { time: m.ts ? new Date(m.ts).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : "" });
  }
}

function setupChat() {
  const jsStatus = $("jsStatus");
  if (jsStatus) jsStatus.textContent = "JS: running";

  setupChatControlsFromState();
  replayMemoryToScreen();

  const form = $("chatForm");
  const input = $("chatInput");
  const newBtn = $("chatNewBtn");
  const saveBtn = $("chatSaveBtn");

  if (newBtn) {
    newBtn.addEventListener("click", () => {
      // Clears only the on-screen chat, keeps memory (because you may want “New” but still remember)
      const chat = $("chat");
      if (chat) chat.innerHTML = "";
      addBubble("system", "New chat started (screen cleared). Memory is still saved unless you press Clear memory.");
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener("click", () => {
      const rows = Array.from(document.querySelectorAll("#chat .bubble-row"));
      const messages = rows.map((r) => {
        const kind = r.classList.contains("user") ? "user" :
                     r.classList.contains("bot") ? "bot" : "system";
        const text = (r.querySelector(".bubble")?.textContent || "").trim();
        const time = (r.querySelector(".msg-meta")?.textContent || "").trim();
        return { kind, text, time };
      }).filter(m => m.text);

      const title = (messages.find(m => m.kind === "user")?.text || "Saved chat").slice(0, 40);
      const saved = JSON.parse(localStorage.getItem("alyana_saved_chats") || "[]");
      saved.unshift({ title: `${title} — ${new Date().toISOString().slice(0,16).replace("T"," ")}`, messages });
      localStorage.setItem("alyana_saved_chats", JSON.stringify(saved));
      loadSavedChats();
      addBubble("system", "Saved.");
    });
  }

  if (form) {
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const q = (input?.value || "").trim();
      if (!q) return;

      // show + save user message
      addBubble("user", q);
      appendToMemory("user", q);

      input.value = "";

      const state = loadChatState();
      const lang = state.lang || "auto";
      const history = getHistoryForBackend();

      try {
        const res = await api("/chat", {
          method: "POST",
          body: JSON.stringify({
            prompt: q,
            lang,
            history, // <— THIS is real memory sent to server
          }),
        });

        const answer = (res.message || "…").trim();
        addBubble("bot", answer);
        appendToMemory("assistant", answer);
      } catch (err) {
        addBubble("system", `Error: ${err.message}`);
      }
    });
  }

  loadSavedChats();
}

/* -----------------------
   Bible Reader
------------------------ */
async function setupBible() {
  const status = $("bibleDbStatus");
  try {
    const h = await api("/bible/health", { method: "GET" });
    if (status) status.textContent = `OK — ${h.verse_count} verses.`;
  } catch (e) {
    if (status) status.textContent = `Bible DB error: ${e.message}`;
    return;
  }

  const bookSelect = $("bookSelect");
  const chapterSelect = $("chapterSelect");
  const verseStartSelect = $("verseStartSelect");
  const verseEndSelect = $("verseEndSelect");

  async function loadBooks() {
    const b = await api("/bible/books", { method: "GET" });
    bookSelect.innerHTML = "";
    b.books.forEach((bk) => {
      const opt = document.createElement("option");
      opt.value = bk.id;
      opt.textContent = bk.name;
      bookSelect.appendChild(opt);
    });
  }

  async function loadChapters(bookId) {
    const c = await api(`/bible/chapters?book=${encodeURIComponent(bookId)}`, { method: "GET" });
    chapterSelect.innerHTML = `<option value="">—</option>`;
    c.chapters.forEach((ch) => {
      const opt = document.createElement("option");
      opt.value = ch;
      opt.textContent = String(ch);
      chapterSelect.appendChild(opt);
    });
  }

  async function loadVerses(bookId, chapter) {
    const v = await api(`/bible/verses?book=${encodeURIComponent(bookId)}&chapter=${encodeURIComponent(chapter)}`, { method: "GET" });
    verseStartSelect.innerHTML = `<option value="">—</option>`;
    verseEndSelect.innerHTML = `<option value="">(optional)</option>`;
    v.verses.forEach((vv) => {
      const o1 = document.createElement("option");
      o1.value = vv;
      o1.textContent = String(vv);
      verseStartSelect.appendChild(o1);

      const o2 = document.createElement("option");
      o2.value = vv;
      o2.textContent = String(vv);
      verseEndSelect.appendChild(o2);
    });
  }

  await loadBooks();

  bookSelect.addEventListener("change", async () => {
    const bid = bookSelect.value;
    if (!bid) return;
    await loadChapters(bid);
  });

  chapterSelect.addEventListener("change", async () => {
    const bid = bookSelect.value;
    const ch = chapterSelect.value;
    if (!bid || !ch) return;
    await loadVerses(bid, ch);
  });

  const listenBtn = $("listenBible");
  const stopBtn = $("stopBible");
  const fullChapter = $("fullChapter");

  function speak(text, lang) {
    window.speechSynthesis.cancel();
    const u = new SpeechSynthesisUtterance(text);
    u.lang = lang === "es" ? "es-MX" : "en-US";
    window.speechSynthesis.speak(u);
  }

  if (listenBtn) {
    listenBtn.addEventListener("click", async () => {
      try {
        const bid = bookSelect.value;
        const ch = parseInt(chapterSelect.value || "0", 10);
        if (!bid || !ch) throw new Error("Pick a book and chapter first.");

        const fc = !!(fullChapter && fullChapter.checked);
        const start = parseInt(verseStartSelect.value || "1", 10);
        const end = parseInt(verseEndSelect.value || String(start), 10);

        const url = fc
          ? `/bible/passage?book=${encodeURIComponent(bid)}&chapter=${encodeURIComponent(ch)}&full_chapter=true`
          : `/bible/passage?book=${encodeURIComponent(bid)}&chapter=${encodeURIComponent(ch)}&start=${encodeURIComponent(start)}&end=${encodeURIComponent(end)}`;

        const p = await api(url, { method: "GET" });
        const voiceLang = ($("readingVoice")?.value || "en");
        speak(p.text || "", voiceLang);
      } catch (e) {
        alert(e.message);
      }
    });
  }

  if (stopBtn) {
    stopBtn.addEventListener("click", () => window.speechSynthesis.cancel());
  }
}

/* -----------------------
   Devotional
------------------------ */
function loadSavedDevotionals() {
  const list = $("devSavedList");
  if (!list) return;

  const saved = JSON.parse(localStorage.getItem("alyana_saved_devotionals") || "[]");
  list.innerHTML = "";
  if (!saved.length) {
    list.innerHTML = `<small style="opacity:0.75;">No saved devotionals yet.</small>`;
    return;
  }

  saved.forEach((item, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "block";

    const btn = document.createElement("button");
    btn.className = "btn btn-ghost";
    btn.textContent = item.title;
    btn.addEventListener("click", () => {
      $("devotionalScripture").textContent = item.scripture || "—";
      $("devotionalExplain").textContent = item.brief_explanation || "—";
      $("devotionalMyExplanation").value = item.my_explanation || "";
      $("devotionalMyApplication").value = item.my_application || "";
      $("devotionalMyPrayer").value = item.my_prayer || "";
      $("devotionalReflection").value = item.reflection || "";
    });

    const del = document.createElement("button");
    del.className = "btn btn-danger";
    del.textContent = "Delete";
    del.style.marginTop = "8px";
    del.addEventListener("click", () => {
      saved.splice(idx, 1);
      localStorage.setItem("alyana_saved_devotionals", JSON.stringify(saved));
      loadSavedDevotionals();
    });

    wrap.appendChild(btn);
    wrap.appendChild(del);
    list.appendChild(wrap);
  });
}

function setupDevotional() {
  const genBtn = $("devotionalBtn");
  const saveBtn = $("devSaveBtn");

  if (genBtn) {
    genBtn.addEventListener("click", async () => {
      try {
        const lang = $("devUiLang")?.value || "en";
        const res = await api("/devotional", { method: "POST", body: JSON.stringify({ lang }) });
        const raw = res.json || "{}";
        const obj = JSON.parse(raw);

        $("devotionalScripture").textContent = obj.scripture || "—";
        $("devotionalExplain").textContent = obj.brief_explanation || "—";
      } catch (e) {
        alert(`Devotional error: ${e.message}`);
      }
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener("click", () => {
      const scripture = $("devotionalScripture").textContent || "";
      const brief = $("devotionalExplain").textContent || "";

      const item = {
        title: (scripture || "Devotional").slice(0, 50) + " — " + new Date().toISOString().slice(0,16).replace("T"," "),
        scripture,
        brief_explanation: brief,
        my_explanation: $("devotionalMyExplanation").value || "",
        my_application: $("devotionalMyApplication").value || "",
        my_prayer: $("devotionalMyPrayer").value || "",
        reflection: $("devotionalReflection").value || "",
      };

      const saved = JSON.parse(localStorage.getItem("alyana_saved_devotionals") || "[]");
      saved.unshift(item);
      localStorage.setItem("alyana_saved_devotionals", JSON.stringify(saved));
      loadSavedDevotionals();
      alert("Saved devotional.");
    });
  }

  loadSavedDevotionals();
}

/* -----------------------
   Daily Prayer
------------------------ */
function loadSavedPrayers() {
  const list = $("prSavedList");
  if (!list) return;

  const saved = JSON.parse(localStorage.getItem("alyana_saved_prayers") || "[]");
  list.innerHTML = "";
  if (!saved.length) {
    list.innerHTML = `<small style="opacity:0.75;">No saved prayers yet.</small>`;
    return;
  }

  saved.forEach((item, idx) => {
    const wrap = document.createElement("div");
    wrap.className = "block";

    const btn = document.createElement("button");
    btn.className = "btn btn-ghost";
    btn.textContent = item.title;
    btn.addEventListener("click", () => {
      $("pA").textContent = item.example_adoration || "—";
      $("pC").textContent = item.example_confession || "—";
      $("pT").textContent = item.example_thanksgiving || "—";
      $("pS").textContent = item.example_supplication || "—";

      $("myAdoration").value = item.my_adoration || "";
      $("myConfession").value = item.my_confession || "";
      $("myThanksgiving").value = item.my_thanksgiving || "";
      $("mySupplication").value = item.my_supplication || "";
      $("prayerNotes").value = item.notes || "";
    });

    const del = document.createElement("button");
    del.className = "btn btn-danger";
    del.textContent = "Delete";
    del.style.marginTop = "8px";
    del.addEventListener("click", () => {
      saved.splice(idx, 1);
      localStorage.setItem("alyana_saved_prayers", JSON.stringify(saved));
      loadSavedPrayers();
    });

    wrap.appendChild(btn);
    wrap.appendChild(del);
    list.appendChild(wrap);
  });
}

function setupPrayer() {
  const genBtn = $("prayerBtn");
  const saveBtn = $("prSaveBtn");

  if (genBtn) {
    genBtn.addEventListener("click", async () => {
      try {
        const lang = $("prUiLang")?.value || "en";
        const res = await api("/daily_prayer", { method: "POST", body: JSON.stringify({ lang }) });
        const raw = res.json || "{}";
        const obj = JSON.parse(raw);

        $("pA").textContent = obj.example_adoration || "—";
        $("pC").textContent = obj.example_confession || "—";
        $("pT").textContent = obj.example_thanksgiving || "—";
        $("pS").textContent = obj.example_supplication || "—";
      } catch (e) {
        alert(`Prayer error: ${e.message}`);
      }
    });
  }

  if (saveBtn) {
    saveBtn.addEventListener("click", () => {
      const item = {
        title: "Prayer — " + new Date().toISOString().slice(0,16).replace("T"," "),
        example_adoration: $("pA").textContent || "",
        example_confession: $("pC").textContent || "",
        example_thanksgiving: $("pT").textContent || "",
        example_supplication: $("pS").textContent || "",
        my_adoration: $("myAdoration").value || "",
        my_confession: $("myConfession").value || "",
        my_thanksgiving: $("myThanksgiving").value || "",
        my_supplication: $("mySupplication").value || "",
        notes: $("prayerNotes").value || "",
      };

      const saved = JSON.parse(localStorage.getItem("alyana_saved_prayers") || "[]");
      saved.unshift(item);
      localStorage.setItem("alyana_saved_prayers", JSON.stringify(saved));
      loadSavedPrayers();
      alert("Saved prayer.");
    });
  }

  loadSavedPrayers();
}

/* -----------------------
   Boot
------------------------ */
window.addEventListener("DOMContentLoaded", async () => {
  setupNav();
  setupBillingButtons();
  setupChat();
  setupDevotional();
  setupPrayer();
  await setupBible();
  await refreshMe();
});





















